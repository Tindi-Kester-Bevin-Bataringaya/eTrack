#! /bin/bash
# set -eu

## 0.SOFTWARE MENU------------------------------------------ ##########

## Creating relevant directories

mkdir Quality_control
mkdir Trimmed_reads
mkdir Assembly_data
mkdir Assembly_Quality
mkdir Annotation
mkdir Resistome
mkdir MLST
mkdir reference
mkdir VCF
mkdir Phylogeny

## 1. QUALITY CONTROL AND TRIMMING METHODS

fastqc eanbit_amr/*.fastq -o Quality_control

multiqc eanbit_amr/. -o Quality_control

for i in `ls -1 eanbit_amr/*_trim1.fastq | sed 's/\_trim1.fastq//'`; do trimmomatic PE -phred33 $i\_trim1.fastq $i\_trim2.fastq $i\_1_paired.fq.gz $i\_1_unpaired.fq.gz $i\_2_paired.fq.gz $i\_2_unpaired.fq.gz ILLUMINACLIP:TruSeq3-PE.fa:2:30:10:2:keepBothReads LEADING:3 TRAILING:3 MINLEN:36; mv $i\_1_paired.fq.gz $i\_1_unpaired.fq.gz $i\_2_paired.fq.gz $i\_2_unpaired.fq.gz Trimmed_reads/; done

## 2. ASSEMBLY, SCAFFOLDING, ANNOTATION

for i in `ls -1 Trimmed_reads/*_1_paired.fq.gz | sed 's/\_1_paired.fq.gz//'`; do unicycler -1 $i\_1_paired.fq.gz -2 $i\_2_paired.fq.gz -o $i\_data; done
for i in `ls -1 Trimmed_reads/*_1_paired.fq.gz | sed 's/\_1_paired.fq.gz//'`; do mv -- $i\_data/"assembly.fasta" "$i.fasta"; done
for i in `ls -1 Trimmed_reads/*.fasta | sed 's/\.fasta//'`; do mv $i\.fasta $i\_data; done
for i in `ls -1 Trimmed_reads/*_1_paired.fq.gz | sed 's/\_1_paired.fq.gz//'`; do mv $i\_data/ Assembly_data/; done 

for i in `ls -1 Assembly_data/*_data/*.fasta | sed 's/\.fasta//'`; do quast $i\.fasta -o $i\_quality/; mv $i\_quality/ Assembly_Quality/;  done

for i in `ls -1 Assembly_data/*_data/*.fasta | sed 's/\.fasta//'`; do prokka --outdir $i\_annotation $i\.fasta; mv $i\_annotation/ Annotation/; done

## 3. VARIANT CALLING

cp Escherichia_coli_str_K-12_substr_MG1655_complete_genome.fasta reference/ref.fa
bwa index reference/ref.fa
for i in `ls -1 Trimmed_reads/*_1_paired.fq.gz | sed 's/\_1_paired.fq.gz//'`; do bwa mem -R "@RG\tID:0\tSM:$i\tPL:Illumina" reference/ref.fa $i\_1_paired.fq.gz $i\_2_paired.fq.gz > $i\.sam; mkdir $i\_VCF; mv $i\.sam $i\_VCF; done
for i in `ls -1 Trimmed_reads/*_VCF/*.sam | sed 's/\.sam//'`; do samtools view -S -b $i\.sam > $i\.bam; samtools sort $i\.bam -o $i\_sorted_file.bam; samtools index $i\_sorted_file.bam; freebayes -f reference/ref.fa --ploidy 1 -b $i\_sorted_file.bam -v $i\.vcf; done
for i in `ls -1 Trimmed_reads/*_1_paired.fq.gz | sed 's/\_1_paired.fq.gz//'`; do mv $i\_VCF VCF/; done

## 4. AMR, VIRULENCE FACTORS, MLST AND PLASMIDS DETECTION

for i in `ls -1 Assembly_data/*_data/*.fasta | sed 's/\.fasta//'`; do abricate $i\.fasta > $i\_resistome.tsv; mv $i\_resistome.tsv Resistome/; done
mlst Assembly_data/*_data/*.fasta > MLST/mlst.tsv

## 5. PANGENOME ANALYSIS

## 6. PHYLOGENETICS

for i in `ls -1 Assembly_data/*_data/*.fasta | sed 's/\.fasta//'`; do cp $i\.fasta Phylogeny/; done
cd Phylogeny/
for i in *.fasta; do awk '/^>/ {gsub(/.fa(sta)?$/,"",FILENAME);printf(">%s\n",FILENAME);next;} {print}' $i > $i.adjusted; done
cat *.adjusted > Ecoli_Assemblies_combined.fasta
sed '/^>/s/ *//' Ecoli_Assemblies_combined.fasta > Ec_edit.fasta | awk 'BEGIN{FS=OFS=">"}NF>1{$3="_sequence_"++i}1' Ec_edit.fasta > EC.fasta
cd ..
mafft --auto Phylogeny/EC.fasta > Phylogeny/EC.aln
iqtree -s Phylogeny/EC.aln 

## REPORTING
